import re
from typing import Dict, List, Tuple, Optional
from enum import Enum
import json

class QueryType(Enum):
    """ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜"""
    COUNTRY_ANALYSIS = "êµ­ê°€ë³„_ë¶„ì„"
    TECH_COMPARISON = "ê¸°ìˆ _ë¹„êµ"
    COOPERATION_STRATEGY = "í˜‘ë ¥_ì „ëµ"
    MARKET_ANALYSIS = "ì‹œì¥_ë¶„ì„"
    INVESTMENT_ROI = "íˆ¬ì_ìˆ˜ìµ"
    ROADMAP_TIMELINE = "ë¡œë“œë§µ_ì¼ì •"
    POLICY_RECOMMENDATION = "ì •ì±…_ì œì–¸"
    RISK_ASSESSMENT = "ë¦¬ìŠ¤í¬_í‰ê°€"
    PRIORITY_RANKING = "ìš°ì„ ìˆœìœ„_ìˆœìœ„"  # ìƒˆë¡œ ì¶”ê°€

class LlamaPromptEngineer:
    """í–¥ìƒëœ ë°©ì‚° í˜‘ë ¥ ì „ëµ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ì‹œìŠ¤í…œ"""
    
    def __init__(self, knowledge_base):
        self.kb = knowledge_base
        self.system_prompt = self._build_system_prompt()
        self.query_patterns = self._build_query_patterns()
        self.pdf_qa_database = self._build_pdf_qa_database()
        
    def _build_system_prompt(self) -> str:
        """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì¶•"""
        return """ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ë°©ì‚°ê¸°ìˆ  ìˆ˜ì¶œ í™•ëŒ€ë¥¼ ìœ„í•œ êµ­ê°€ë³„ í˜‘ë ¥ ì „ëµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ì—­í•  ë° ì „ë¬¸ì„±
- ë¹„NATO êµ­ê°€ì™€ì˜ ë°©ì‚° í˜‘ë ¥ ì „ëµ ìˆ˜ë¦½
- êµ­ê°€ë³„ êµ­ë°© ëŠ¥ë ¥, ê¸°ìˆ  ì—­ëŸ‰, ìƒë³´ì  ê¸°ìˆ  ë¶„ì•¼ ë¶„ì„
- ë°©ì‚° ìˆ˜ì¶œ ì‹œì¥ ë¶„ì„ ë° íˆ¬ì ìˆ˜ìµì„± í‰ê°€
- ë‹¨ê³„ì  í˜‘ë ¥ ë¡œë“œë§µ ë° ì •ì±… ì œì–¸ ì œê³µ

## ì‘ë‹µ ì›ì¹™
1. **ì •í™•ì„±**: ì œê³µëœ ë°ì´í„°ì™€ ë¶„ì„ì— ê¸°ë°˜í•œ ì‚¬ì‹¤ì  ì •ë³´ ì œê³µ
2. **êµ¬ì²´ì„±**: êµ¬ì²´ì  ìˆ˜ì¹˜, ì¼ì •, í”„ë¡œì íŠ¸ëª… í¬í•¨
3. **ì‹¤ìš©ì„±**: ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ëµê³¼ ë‹¨ê³„ë³„ ì‹¤í–‰ë°©ì•ˆ ì œì‹œ
4. **ê· í˜•ì„±**: ê¸°íšŒì™€ ë¦¬ìŠ¤í¬ë¥¼ ê· í˜•ìˆê²Œ í‰ê°€
5. **ì™„ì „ì„±**: ì§ˆë¬¸ì— ëŒ€í•œ ì™„ì „í•˜ê³  í¬ê´„ì ì¸ ë‹µë³€ ì œê³µ

## ì¤‘ìš”: ì§€ì‹ ë²”ìœ„
- ë°©ì‚° í˜‘ë ¥, ê¸°ìˆ  ì´ì „, êµ­ê°€ë³„ ì „ëµì— ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€
- ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ ì§ˆë¬¸ì—ëŠ” ì •ì¤‘íˆ ì•ˆë‚´í•˜ê³  ê´€ë ¨ ì§ˆë¬¸ì„ ìœ ë„
- ë¶ˆí™•ì‹¤í•œ ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ë§ê³  ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰"""

    def _build_query_patterns(self) -> Dict[QueryType, List[str]]:
        """ì§ˆë¬¸ ìœ í˜•ë³„ íŒ¨í„´ ì •ì˜ - ìš°ì„ ìˆœìœ„ íŒ¨í„´ ì¶”ê°€"""
        return {
            QueryType.PRIORITY_RANKING: [
                r"ìš°ì„ ìˆœìœ„.*?(êµ­ê°€|ìˆœìœ„)",
                r"ìˆœìœ„.*?(ì•Œë ¤|ì œì‹œ|ì„¤ëª…)",
                r"1ìˆœìœ„|2ìˆœìœ„|3ìˆœìœ„",
                r"ìš°ì„ .*?(ì„ ì •|ì„ íƒ|ëŒ€ìƒ)"
            ],
            QueryType.COUNTRY_ANALYSIS: [
                r"(\w+)\s*(êµ­ê°€?|ë‚˜ë¼).*?(ë¶„ì„|í‰ê°€|í˜„í™©)",
                r"(\w+).*?(êµ­ë°©|ë°©ì‚°).*?(ëŠ¥ë ¥|ì—­ëŸ‰)",
                r"(\w+).*?(ì‹œì¥|íˆ¬ì|í˜‘ë ¥)\s*í™˜ê²½"
            ],
            QueryType.TECH_COMPARISON: [
                r"(ê¸°ìˆ |ê³¼í•™ê¸°ìˆ ).*?(ë¹„êµ|ì°¨ì´|ëŒ€ë¹„)",
                r"(\w+)\s*(ê¸°ìˆ |ì—­ëŸ‰).*?(í•œêµ­|ìš°ë¦¬ë‚˜ë¼)",
                r"ìƒë³´ì ?.*?(ê¸°ìˆ |í˜‘ë ¥|ë¶„ì•¼)"
            ],
            QueryType.COOPERATION_STRATEGY: [
                r"í˜‘ë ¥.*?(ì „ëµ|ë°©ì•ˆ|ê³„íš)",
                r"ê³µë™.*?(ê°œë°œ|ìƒì‚°|í”„ë¡œì íŠ¸)",
                r"íŒŒíŠ¸ë„ˆì‹­.*?(êµ¬ì¶•|ê°•í™”)"
            ],
            QueryType.INVESTMENT_ROI: [
                r"íˆ¬ì.*?(ê·œëª¨|ìˆ˜ìµ|íš¨ê³¼)",
                r"ROI|ìˆ˜ìµë¥ |ê²½ì œ.*?íš¨ê³¼",
                r"ë¹„ìš©.*?(í¸ìµ|ëŒ€ë¹„)"
            ]
        }

    def _build_pdf_qa_database(self) -> Dict[str, Dict]:
        """PDF ê¸°ë°˜ ì§ˆë¬¸-ë‹µë³€ ë°ì´í„°ë² ì´ìŠ¤"""
        return {
            "ì¤‘ë™_ìš°ì„ ìˆœìœ„": {
                "keywords": ["ì¤‘ë™", "ë¶ì•„í”„ë¦¬ì¹´", "ìš°ì„ ìˆœìœ„", "ìˆœìœ„"],
                "response": """ì¤‘ë™ ë° ë¶ì•„í”„ë¦¬ì¹´ ì§€ì—­ì˜ ë°©ì‚° ìˆ˜ì¶œ ìš°ì„ ìˆœìœ„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

**1ìˆœìœ„: UAE (ì•„ëì—ë¯¸ë¦¬íŠ¸)**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 220ì–µ ë‹¬ëŸ¬
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: ë¯¸ì‚¬ì¼ ë°©ì–´, ì „ìì „, ë¬´ì¸ ì‹œìŠ¤í…œ
- ìƒë³´ì  ê¸°ìˆ : ê³ ê¸‰ ë ˆì´ë” ì‹œìŠ¤í…œ, ì „ìì •ë³´ ì‹œìŠ¤í…œ
- ì‹œì¥ ê¸°íšŒ: ê¸°ìˆ  ë‹¤ë³€í™” ì¶”ì§„ìœ¼ë¡œ ìƒˆë¡œìš´ íŒŒíŠ¸ë„ˆ ëª¨ìƒ‰ ì¤‘
- í˜‘ë ¥ ìš©ì´ì„±: ë†’ìŒ (í•œ-UAE íŠ¹ë³„ ì „ëµì  íŒŒíŠ¸ë„ˆì‹­)

**2ìˆœìœ„: ì´ì§‘íŠ¸**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 50ì–µ ë‹¬ëŸ¬ (ì•„í”„ë¦¬ì¹´ ìµœëŒ€)
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: ì‚¬ë§‰ í™˜ê²½ ìš´ìš©, ë°©ê³µë§ ìš´ìš©, ëŒ€í…ŒëŸ¬ ì¥ë¹„
- ìƒë³´ì  ê¸°ìˆ : ê·¹í•œ ì‚¬ë§‰í™˜ê²½ ì¥ë¹„ ìš´ìš© ë…¸í•˜ìš°
- ì‹œì¥ ê¸°íšŒ: K9 ìì£¼í¬ ìˆ˜ì¶œ ë“± ê¸°ì¡´ í˜‘ë ¥ ê²½í—˜

**3ìˆœìœ„: ì¹´íƒ€ë¥´**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì¤‘ê°„ ê·œëª¨ì´ë‚˜ êµ¬ë§¤ë ¥ ìš°ìˆ˜
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: ë°©ê³µ, í•´ì–‘ ë³´ì•ˆ
- í˜‘ë ¥ ì¥ë²½: ì§€ì—­ ì •ì¹˜ì  ë³µì¡ì„±

**4ìˆœìœ„: ëª¨ë¡œì½”**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ìƒëŒ€ì ìœ¼ë¡œ ì œí•œì 
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: êµ­ê²½ ê°ì‹œ, ëŒ€í…ŒëŸ¬
- ì‹œì¥ ê¸°íšŒ: ì•„í”„ë¦¬ì¹´ ì§„ì¶œ êµë‘ë³´ ê°€ëŠ¥"""
            },
            "ë‚¨ì•„ì‹œì•„_ìš°ì„ ìˆœìœ„": {
                "keywords": ["ë‚¨ì•„ì‹œì•„", "ë™ë‚¨ì•„ì‹œì•„", "ìš°ì„ ìˆœìœ„", "ì¸ë„"],
                "response": """ë‚¨ì•„ì‹œì•„ ë° ë™ë‚¨ì•„ì‹œì•„ ì§€ì—­ì˜ ë°©ì‚° ìˆ˜ì¶œ ìš°ì„ ìˆœìœ„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

**1ìˆœìœ„: ì¸ë„**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 730ì–µ ë‹¬ëŸ¬ (ì„¸ê³„ 3ìœ„)
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: ë¯¸ì‚¬ì¼ ê¸°ìˆ , í•­ê³µìš°ì£¼, ì „ìì „
- ìƒë³´ì  ê¸°ìˆ : ë¯¸ì‚¬ì¼ ìœ ë„ ì‹œìŠ¤í…œ, ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ, ìœ„ì„± ê¸°ìˆ 
- ì‹œì¥ ê¸°íšŒ: 'Make in India' ì •ì±…ìœ¼ë¡œ ê³µë™ìƒì‚° ê°€ëŠ¥ì„± ë†’ìŒ
- ì „ëµì  ì¤‘ìš”ì„±: ë§¤ìš° ë†’ìŒ

**2ìˆœìœ„: ì¸ë„ë„¤ì‹œì•„**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 90ì–µ ë‹¬ëŸ¬
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: í•´ì–‘ ì•ˆë³´, ì—´ëŒ€í™˜ê²½ ì¥ë¹„
- ìƒë³´ì  ê¸°ìˆ : ì—´ëŒ€/í•´ì–‘ í™˜ê²½ ìµœì í™” ê¸°ìˆ 
- í˜‘ë ¥ ê²½í—˜: KF-21 ê³µë™ê°œë°œ íŒŒíŠ¸ë„ˆ
- ì‹œì¥ ê¸°íšŒ: ì•„ì„¸ì•ˆ ìµœëŒ€ ì‹œì¥

**3ìˆœìœ„: íƒœêµ­**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 70ì–µ ë‹¬ëŸ¬
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: êµ­ê²½ ê°ì‹œ, ëŒ€í…ŒëŸ¬ ì¥ë¹„
- ê¸°ì¡´ í˜‘ë ¥: K9 ìì£¼í¬ ë„ì… ê²½í—˜
- ìƒë³´ì  ê¸°ìˆ : ì—´ëŒ€ í™˜ê²½ ìš´ìš© ê¸°ìˆ 

**4ìˆœìœ„: ë§ë ˆì´ì‹œì•„**
- ë°©ìœ„ì‚°ì—… íˆ¬ì: ì—°ê°„ ì•½ 40ì–µ ë‹¬ëŸ¬
- ì¤‘ì  ê¸°ìˆ  ì˜ì—­: í•´ì–‘ ê°ì‹œ, ì‚¬ì´ë²„ ë°©ì–´
- í˜‘ë ¥ ê²½í—˜: FA-50 ë„ì…
- ì‹œì¥ íŠ¹ì„±: ì¤‘ê¸‰ ê·œëª¨ì´ë‚˜ ì•ˆì •ì """
            },
            "ì¸ë„_ë¯¸ì‚¬ì¼_í˜‘ë ¥": {
                "keywords": ["ì¸ë„", "ë¯¸ì‚¬ì¼", "í˜‘ë ¥", "BrahMos", "í˜„ë¬´"],
                "response": """### ğŸš€ í˜„ë¬´-BrahMos í•©ë™ ë¯¸ì‚¬ì¼ ê°œë°œ í”„ë¡œê·¸ë¨
- **ì¸ë„ êµ­ë°©ì˜ˆì‚°**: 730ì–µ ë‹¬ëŸ¬ (2024ë…„ ê¸°ì¤€, ì„¸ê³„ 3ìœ„)
- **BrahMos ê¸°ìˆ ë ¥**: ë§ˆí•˜ 2.8~3.0 ì´ˆìŒì† ìˆœí•­ë¯¸ì‚¬ì¼, ëŸ¬ì‹œì•„ í•©ì‘ ì„±ê³µì‚¬ë¡€
- **í˜„ë¬´ ì‹œë¦¬ì¦ˆ**: ì‚¬ê±°ë¦¬ 300-800km, í•œêµ­ ë…ìê°œë°œ ì •ë°€íƒ€ê²© ë¬´ê¸°ì²´ê³„
- **ì‹œì¥ ì ì¬ë ¥**: ë™ë‚¨ì•„-ì¤‘ë™ ì •ë°€íƒ€ê²© ì‹œì¥ ì—° 5.8% ì„±ì¥, 118ì–µ ë‹¬ëŸ¬ ê·œëª¨

### ğŸ’° 3ë‹¨ê³„ íˆ¬ì ê³„íš (ì´ 23ì–µ ë‹¬ëŸ¬)
**1ë‹¨ê³„: ê³µë™ì—°êµ¬ê°œë°œ (2025-2026, 3ì–µ ë‹¬ëŸ¬)**
- í•œêµ­ íˆ¬ì: 1.8ì–µ ë‹¬ëŸ¬ (ì¶”ì§„ì²´, ì‹œìŠ¤í…œ í†µí•©)
- ì¸ë„ íˆ¬ì: 1.2ì–µ ë‹¬ëŸ¬ (ìœ ë„ì‹œìŠ¤í…œ, AI ì†Œí”„íŠ¸ì›¨ì–´)
- ë¶€ì‚°-ì²¸ë‚˜ì´ Twin R&D Center ì„¤ë¦½
- ìƒí˜¸ ê¸°ìˆ ì§„ íŒŒê²¬: í•œêµ­ 50ëª… â†” ì¸ë„ 60ëª…

**2ë‹¨ê³„: í”„ë¡œí† íƒ€ì… ê°œë°œ (2026-2028, 8ì–µ ë‹¬ëŸ¬)**
- 50:50 íˆ¬ì ë¶„ë‹´ (ê° 4ì–µ ë‹¬ëŸ¬)
- ëª©í‘œ ì„±ëŠ¥: ì‚¬ê±°ë¦¬ 1,500km, CEP 1m ì´í•˜
- ì‹œí—˜ì¥: ì¸ë„ ì¹¼ëŒì„¬, í•œêµ­ ì•ˆí¥ì‹œí—˜ì¥
- MTCR ê·œì œ ëŒ€ì‘: 300km ë²„ì „ë¶€í„° ë‹¨ê³„ì  ê°œë°œ

**3ë‹¨ê³„: ì–‘ì‚° ë° ìˆ˜ì¶œ (2028-2030, 12ì–µ ë‹¬ëŸ¬)**
- í•œêµ­ ìƒì‚°ë¶„: 5ì–µ ë‹¬ëŸ¬ (ì—°ê°„ 80ê¸°)
- ì¸ë„ ìƒì‚°ë¶„: 7ì–µ ë‹¬ëŸ¬ (ì—°ê°„ 120ê¸°, Make in India 60% í˜„ì§€í™”)
- 1ì°¨ ìˆ˜ì¶œ ëŒ€ìƒ: ë² íŠ¸ë‚¨ 50ê¸°, í•„ë¦¬í•€ 30ê¸°, íƒœêµ­ 40ê¸°

### ğŸ“Š íˆ¬ììˆ˜ìµë¥  ë¶„ì„ (10ë…„ ê¸°ì¤€)
- **ì§ì ‘ ìˆ˜ì¶œìˆ˜ìµ**: 40ì–µ ë‹¬ëŸ¬ (ë¯¸ì‚¬ì¼ ë³¸ì²´ íŒë§¤)
- **ê¸°ìˆ  ë¼ì´ì„¼ì‹±**: 8ì–µ ë‹¬ëŸ¬ (í˜„ì§€ìƒì‚° ë¡œì—´í‹° 3-5%)
- **MRO ì„œë¹„ìŠ¤**: 12ì–µ ë‹¬ëŸ¬ (20ë…„ ìœ ì§€ë³´ìˆ˜ ê³„ì•½)
- **ì´ ROI**: 332% (íšŒìˆ˜ê¸°ê°„ 4.8ë…„)
- **ê³ ìš©ì°½ì¶œ**: ì§ê°„ì ‘ 15,000ëª…

### ğŸ¯ ê¸°ìˆ  ìœµí•© í˜ì‹ ì 
**ì¶”ì§„ì²´ ê¸°ìˆ  ê²°í•©**
- ì¸ë„ ë¨ì œíŠ¸ ì—”ì§„ + í•œêµ­ ê³ ì²´ì¶”ì§„ì²´
- ì—°ë£Œíš¨ìœ¨ 35% ê°œì„ , ì‚¬ê±°ë¦¬ 20% ì—°ì¥
- í•˜ì´ë¸Œë¦¬ë“œ ê¶¤ë„: ì´ˆìŒì† ìˆœí•­ + íƒ„ë„ë¯¸ì‚¬ì¼ ë³µí•©

**AI ê¸°ë°˜ ì •ë°€ ìœ ë„**
- ì¸ë„ AI ì†Œí”„íŠ¸ì›¨ì–´ (93% ìœ„í˜‘ì‹ë³„ ì •í™•ë„)
- í•œêµ­ í•˜ë“œì›¨ì–´ í”Œë«í¼ (ë‹¤ì¤‘ì„¼ì„œ ìœµí•©)
- ì‹¤ì‹œê°„ í‘œì  ì‹ë³„ ë° ë¶€ìˆ˜í”¼í•´ ìµœì†Œí™”

### ğŸŒ ì§€ì •í•™ì  ì˜ë¯¸
- **Quad ì²´ì œ ê°•í™”**: ì¸ë„-íƒœí‰ì–‘ ì „ëµì—ì„œ í•œêµ­ ì—­í•  í™•ëŒ€
- **ì¤‘êµ­ ê²¬ì œ**: ë™ì•„ì‹œì•„-ë‚¨ì•„ì‹œì•„ ì—°ê²°ì¶• í˜•ì„±  
- **ê¸°ìˆ  ìë¦½**: ì„œêµ¬ ì˜ì¡´ë„ ê°ì†Œ, ì•„ì‹œì•„ ê¸°ìˆ ìƒíƒœê³„ êµ¬ì¶•

*[AI ë¶„ì„ - ì¸ë„ DRDO ê³µì‹ ë°ì´í„° ê¸°ë°˜]*"""
            },
            "UAE_íˆ¬ì": {
                "keywords": ["UAE", "íˆ¬ì", "ê·œëª¨", "ì•„ëì—ë¯¸ë¦¬íŠ¸"],
                "response": """### ğŸ‡¦ğŸ‡ª UAEì™€ í•œêµ­ì˜ ê¸°ìˆ  í†µí•© ì „ëµ ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸

## 1. ì‚¬ë§‰í™˜ê²½ ìµœì í™” í†µí•© ë°©ê³µì‹œìŠ¤í…œ
**í˜‘ë ¥ êµ¬ì¡°:**
- í•œêµ­: ì²œê¶ ë¯¸ì‚¬ì¼ ì‹œìŠ¤í…œ + ì‹œìŠ¤í…œ í†µí•© ê¸°ìˆ 
- UAE: ê³ ì˜¨í™˜ê²½ ì ì‘ ê¸°ìˆ  + í˜„ì§€ ë§ì¶¤í™” ê¸°ìˆ 
- íˆ¬ì ê·œëª¨: ì´ 7ì–µ ë‹¬ëŸ¬ (í•œêµ­ 4ì–µ, UAE 3ì–µ)
- ìƒì‚° ë¶„ë‹´: í•œêµ­ 60%, UAE 40%

**ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸:**
- Phase 1: ê³µë™ê°œë°œ (2ë…„, 2ì–µ ë‹¬ëŸ¬)
- Phase 2: ì‹œì œí’ˆ ì œì‘ ë° ì‹œí—˜ (1ë…„, 1.5ì–µ ë‹¬ëŸ¬)
- Phase 3: ì–‘ì‚° ë° GCC ì§€ì—­ ë§ˆì¼€íŒ… (3ë…„, 3.5ì–µ ë‹¬ëŸ¬)

## 2. í†µí•© C4ISR ì²´ê³„ ê°œë°œ
**í˜‘ë ¥ êµ¬ì¡°:**
- í•œêµ­: TICN ì§€íœ˜í†µì œ ì²´ê³„ + ë„¤íŠ¸ì›Œí¬ ê¸°ìˆ 
- UAE: NASSR ê³ ì„±ëŠ¥ ë ˆì´ë” + ê·¹í•œê¸°í›„ ì ì‘ ê¸°ìˆ 
- íˆ¬ì ê·œëª¨: ì´ 8ì–µ ë‹¬ëŸ¬ (50:50 ë¶„ë‹´)

**ìˆ˜ìµ ëª¨ë¸:**
- ê¸°ìˆ  ë¼ì´ì„¼ì‹±: ìƒì‚°ì•¡ì˜ 3-5% ë¡œì—´í‹°
- ìœ ì§€ë³´ìˆ˜ ì„œë¹„ìŠ¤: ì—°ê°„ ë§¤ì¶œì˜ 15-20%
- ì—…ê·¸ë ˆì´ë“œ íŒ¨í‚¤ì§€: ì‹œìŠ¤í…œ ê°€ê²©ì˜ 30-40%

## 3. ë“œë¡  ë°©ì–´ í†µí•© ì†”ë£¨ì…˜
**í˜ì‹ ì  í˜‘ë ¥ ëª¨ë¸:**
- í•œêµ­: ì•ˆí‹°ë“œë¡  ë ˆì´ë” + í•˜ë“œì›¨ì–´ í”Œë«í¼
- UAE: D-Fend ì „ìì „ ê¸°ìˆ  + AI ê¸°ë°˜ ìœ„í˜‘ ë¶„ì„
- ì‹œì¥ í™•ì¥: êµ°ì‚¬ìš© â†’ ë¯¼ê°„ ì¸í”„ë¼ ë³´í˜¸ë¡œ í™•ëŒ€

**ì˜ˆìƒ íš¨ê³¼:**
- ê²½ì œì : 10ë…„ê°„ 90ì–µ ë‹¬ëŸ¬ ìˆ˜ì¶œ ì°½ì¶œ
- ê¸°ìˆ ì : ê·¹í•œí™˜ê²½ ê¸°ìˆ  í™•ë³´ë¡œ ê¸€ë¡œë²Œ ê²½ìŸë ¥ ê°•í™”
- ì „ëµì : ì¤‘ë™ ë°©ì‚° í˜‘ë ¥ í—ˆë¸Œ êµ¬ì¶•"""
            }
        }
    
    def classify_query(self, user_query: str) -> Tuple[QueryType, Dict]:
        """ì‚¬ìš©ì ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜ ë° í‚¤ì›Œë“œ ì¶”ì¶œ"""
        extracted_info = {
            "countries": [],
            "tech_fields": [],
            "keywords": []
        }
        
        # êµ­ê°€ëª… ì¶”ì¶œ
        countries = ["ì¸ë„", "UAE", "ë¸Œë¼ì§ˆ", "ì¸ë„ë„¤ì‹œì•„", "ë§ë ˆì´ì‹œì•„", 
                    "íƒœêµ­", "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­", "ë‚¨ì•„ê³µ", "ì´ì§‘íŠ¸", "ì¤‘ë™", 
                    "ë¶ì•„í”„ë¦¬ì¹´", "ë‚¨ì•„ì‹œì•„", "ë™ë‚¨ì•„ì‹œì•„"]
        for country in countries:
            if country in user_query:
                extracted_info["countries"].append(country)
        
        # ê¸°ìˆ  ë¶„ì•¼ ì¶”ì¶œ
        tech_fields = ["ë¯¸ì‚¬ì¼", "ë°©ê³µ", "í•­ê³µ", "í•´êµ°", "ì „ìì „", "ì‚¬ì´ë²„", 
                      "ë ˆì´ë”", "ë¬´ì¸", "ë“œë¡ ", "C4ISR", "ê°ì‹œì •ì°°"]
        for field in tech_fields:
            if field in user_query:
                extracted_info["tech_fields"].append(field)
        
        # ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜ - ìš°ì„ ìˆœìœ„ ìš°ì„  ê²€ì‚¬
        for query_type, patterns in self.query_patterns.items():
            for pattern in patterns:
                if re.search(pattern, user_query):
                    return query_type, extracted_info
        
        return QueryType.COUNTRY_ANALYSIS, extracted_info
    
    def find_pdf_answer(self, user_query: str) -> Optional[str]:
        """PDF ë°ì´í„°ì—ì„œ ì •í™•í•œ ë‹µë³€ ì°¾ê¸°"""
        query_lower = user_query.lower()
        
        for qa_key, qa_data in self.pdf_qa_database.items():
            keywords = qa_data["keywords"]
            # í‚¤ì›Œë“œ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
            match_score = sum(1 for keyword in keywords if keyword in query_lower)
            keyword_threshold = len(keywords) * 0.5  # 50% ì´ìƒ ë§¤ì¹­
            
            if match_score >= keyword_threshold:
                return qa_data["response"]
        
        return None
    
    def retrieve_context(self, query_type: QueryType, extracted_info: Dict) -> str:
        """ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¥¸ ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ ê²€ìƒ‰"""
        context_parts = []
        
        if query_type == QueryType.COUNTRY_ANALYSIS or query_type == QueryType.PRIORITY_RANKING:
            for country in extracted_info["countries"]:
                if country in self.kb.countries:
                    profile = self.kb.countries[country]
                    context_parts.append(f"""
## {country} êµ­ë°© í”„ë¡œí•„
- êµ­ë°©ì˜ˆì‚°: {profile.defense_budget}
- ë³‘ë ¥ê·œëª¨: {profile.military_personnel}  
- ì£¼ìš” ë°©ì‚°ê¸°ì—…: {', '.join(profile.defense_companies)}
- ì „ëµì  ì¤‘ìš”ë„: {profile.strategic_importance}
- í˜‘ë ¥ ìš©ì´ì„±: {profile.cooperation_feasibility}
""")
        
        elif query_type == QueryType.TECH_COMPARISON:
            for country in extracted_info["countries"]:
                if country in self.kb.countries:
                    comp_tech = self.kb.countries[country].complementary_tech
                    context_parts.append(f"""
## {country} ê¸°ìˆ  ìƒë³´ì„± ë¶„ì„
### í•œêµ­ ê°•ì ê¸°ìˆ :
{chr(10).join(['- ' + tech for tech in comp_tech.korea_strengths])}

### {country} ê°•ì ê¸°ìˆ :
{chr(10).join(['- ' + tech for tech in comp_tech.partner_strengths])}

### ê³µë™ê°œë°œ ì ì¬ë¶„ì•¼:
{chr(10).join(['- ' + tech for tech in comp_tech.joint_potential])}
""")
        
        return "\n".join(context_parts) if context_parts else ""
    
    def generate_diversified_prompt(self, user_query: str, attempt: int = 0) -> str:
        """ë‹¤ì–‘ì„±ì´ ê°•í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        # PDF ë°ì´í„°ì—ì„œ ì •í™•í•œ ë‹µë³€ ì°¾ê¸°
        pdf_answer = self.find_pdf_answer(user_query)
        if pdf_answer:
            return pdf_answer
        
        query_type, extracted_info = self.classify_query(user_query)
        context = self.retrieve_context(query_type, extracted_info)
        
        # ë‹¤ì–‘ì„± ì§€ì‹œì‚¬í•­
        diversity_instructions = [
            "PDF ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”.",
            "ì‹¤ì œ ë°ì´í„°ì™€ ìˆ˜ì¹˜ë¥¼ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”.", 
            "ë‹¨ê³„ë³„ ì‹¤í–‰ ë°©ì•ˆê³¼ êµ¬ì²´ì  íˆ¬ì ê·œëª¨ë¥¼ ì œì‹œí•˜ì„¸ìš”.",
            "ê¸°ìˆ ì  ìƒë³´ì„±ê³¼ ì§€ì •í•™ì  ì˜ë¯¸ë¥¼ í•¨ê»˜ ë¶„ì„í•˜ì„¸ìš”.",
            "ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒë¥¼ ê· í˜•ìˆê²Œ í‰ê°€í•˜ì—¬ ì œì‹œí•˜ì„¸ìš”."
        ]
        
        # ì‘ë‹µ êµ¬ì¡° ë‹¤ì–‘í™”
        structure_variants = [
            "### ğŸ“Š í•µì‹¬ ë¶„ì„\n### ğŸ¯ ì „ëµì  ì œì–¸\n### ğŸ“ˆ ê¸°ëŒ€íš¨ê³¼ ë° ë¦¬ìŠ¤í¬\n### ğŸ’¡ ì¶”ê°€ ê³ ë ¤ì‚¬í•­",
            "### ğŸ” ì‹¬ì¸µ ë¶„ì„\n### ğŸš€ ì¶”ì§„ ì „ëµ\n### ğŸ’° ìˆ˜ìµì„± ë¶„ì„\n### ğŸŒŸ ì°¨ë³„í™” ë°©ì•ˆ",
            "### ğŸ“ˆ ì „ëµ ë¶„ì„\n### ğŸ“‹ ì‹¤í–‰ ë°©ì•ˆ\n### âš–ï¸ ì¥ë‹¨ì  í‰ê°€\n### ğŸ”® ë¯¸ë˜ ì „ë§",
            "### ğŸ¯ í˜„í™© í‰ê°€\n### ğŸ”„ í˜‘ë ¥ ì „ëµ\n### ğŸ² ê¸°íšŒì™€ ìœ„í—˜\n### ğŸ’ í˜ì‹  ë°©ì•ˆ",
            "### ğŸ’¼ ì‹œì¥ ë¶„ì„\n### ğŸ’¡ í˜ì‹  ê´€ì \n### ğŸ“Š íˆ¬ì ëŒ€ë¹„ íš¨ê³¼\n### ğŸŒ ê¸€ë¡œë²Œ ê´€ì "
        ]
        
        selected_instruction = diversity_instructions[attempt % len(diversity_instructions)]
        selected_structure = structure_variants[attempt % len(structure_variants)]
        
        user_prompt = f"""## ë°°ê²½ ì •ë³´
{context}

## ì‚¬ìš©ì ì§ˆë¬¸
{user_query}

## íŠ¹ë³„ ì§€ì‹œì‚¬í•­
{selected_instruction}

## ìš”ì²­ì‚¬í•­
ìœ„ ë°°ê²½ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì™„ì „í•˜ê³  ìƒì„¸í•œ ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”:

{selected_structure}

ì¤‘ìš”: 
- ëª¨ë“  ë‚´ìš©ì„ ë¹ ì§ì—†ì´ í¬ê´„ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ ë°ì´í„°ë¥¼ í¬í•¨í•˜ì„¸ìš”
- ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì  ë°©ì•ˆì„ ì œì‹œí•˜ì„¸ìš”
- ë‹µë³€ì„ ì¤‘ê°„ì— ìë¥´ì§€ ë§ê³  ì™„ì „íˆ ì œê³µí•˜ì„¸ìš”
"""
        
        return user_prompt
    
    def generate_prompt(self, user_query: str) -> str:
        """ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ìƒì„± (í•˜ìœ„ í˜¸í™˜ì„±)"""
        # PDF ë°ì´í„° ìš°ì„  í™•ì¸
        pdf_answer = self.find_pdf_answer(user_query)
        if pdf_answer:
            return pdf_answer
            
        return self.generate_diversified_prompt(user_query, 0)

    def is_defense_related(self, query: str) -> bool:
        """ë°©ì‚° ê´€ë ¨ ì§ˆë¬¸ì¸ì§€ í™•ì¸"""
        defense_keywords = [
            "ë°©ì‚°", "ë¯¸ì‚¬ì¼", "ë°©ì–´", "êµ°ì‚¬", "ë¬´ê¸°", "í˜‘ë ¥", "ìˆ˜ì¶œ", "íˆ¬ì",
            "ì¸ë„", "UAE", "ë¸Œë¼ì§ˆ", "ì¤‘ë™", "ë™ë‚¨ì•„", "ì•„í”„ë¦¬ì¹´", "ê¸°ìˆ ì´ì „",
            "ì‚¬ì´ë²„", "ìš°ì£¼", "í•­ê³µ", "í•´ì–‘", "AI", "ë“œë¡ ", "ë ˆì´ë”", "ë°©ê³µ"
        ]
        
        query_lower = query.lower()
        return any(keyword in query_lower for keyword in defense_keywords)

def create_comprehensive_prompt_system(knowledge_base):
    """ì¢…í•©ì ì¸ í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ ìƒì„±"""
    engineer = LlamaPromptEngineer(knowledge_base)
    
    def get_response_prompt(user_query: str, attempt: int = 0) -> str:
        """ì‚¬ìš©ì ì¿¼ë¦¬ì— ëŒ€í•œ ì™„ì „í•œ ì‘ë‹µ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return engineer.generate_diversified_prompt(user_query, attempt)
    
    def check_scope(user_query: str) -> bool:
        """ì§ˆë¬¸ì´ ë°©ì‚° í˜‘ë ¥ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸"""
        return engineer.is_defense_related(user_query)
    
    # ê¸°ì¡´ ë°©ì‹ë„ ì§€ì›
    engineer.get_response_prompt = get_response_prompt
    engineer.check_scope = check_scope
    return engineer